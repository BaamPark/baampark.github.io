---
title: 'Smoothed Particle Hydrodynamics Simulation with CUDA'
date: '2025-04-06T15:04:51-05:00'
draft: False
params:
  math: true
tags: [OpenGL, CUDA]
---

## Mathmatical background
### Algorithm
1. Create particles arranged evenly in a 3D grid
2. for all \(i\) do
    - compute density
    - compute pressure
3. for all \(i\) do
    - compute forces
4. for all \(i\) do
    - update velocity
    - update position
    - collision handling
5. repeat 2 to 4

### Density Computation
The density \(\rho_i\) at particle \(i\) is computed by summing contributions from neighboring particles \(j\):
\[
    \rho_i  \sum_j m_j W_{poly6}(r_{ij},h)
    \]
- \(m_j\): mass of particle \(j\)
- \(r_{ij}\): distance between particles \(i\) and \(j\)
- \(h\): smoothing radius
- \(W_{poly6}\) kernel smoothing function
\[
W_{\text{poly6}}(r, h) =
\begin{cases}
\dfrac{315}{64 \pi h^9}(h^2 - r^2)^3, & r \leq h \\
0, & r > h
\end{cases}
\]

### Pressure Computation (Equation of State)
The pressure \(p_i\) at particle \(i\) is determined from the density deviation using an equation of state:
\[p_i = k(\rho_i - \rho_0)\]
- \(k\): Gas constant
- \(\rho_0\): rest density

### Momentum Equation (Navier-Stokes Forces)
For particle \( i \), the total force \( \mathbf{F}_i \) includes pressure, viscosity, and gravity:
\[
\mathbf{F}_i = \mathbf{F}_i^{\text{pressure}} + \mathbf{F}_i^{\text{viscosity}} + \mathbf{F}_i^{\text{gravity}}
\]
- \(\mathbf{F}_i^{\text{pressure}} = -\sum_{j \ne i} m \frac{p_i + p_j}{2\rho_j} \nabla W_{\text{spiky}}(\mathbf{r}_{ij}, h)\)
    - \(m\): mass of particle \(j\)
    - \(p\): pressure of a particle
    -  \(\nabla W_{\text{spiky}}\): Spiky Gradient
        \[
        \nabla W_{\text{spiky}}(\mathbf{r}, h) =
        \begin{cases}
        -\dfrac{45}{\pi h^6}(h - r)^2 \dfrac{r_{ij}}{r}, & 0 < r \leq h \\
        0, & \text{otherwise}
        \end{cases}
        \]
- \(\mathbf{F}_i^{\text{viscosity}} = \sum_{j \ne i} \mu m_j \frac{\mathbf{v}_j - \mathbf{v}_i}{\rho_j} \nabla^2 W_{\text{viscosity}}(\mathbf{r}_{ij}, h)\)
    - \(\mu\): viscosity coefficient
    - \(v\): velocity
    - Viscosity Laplacian \( \nabla^2 W_{\text{viscosity}}\)
        \[
        \nabla^2 W_{\text{viscosity}}(r, h) =
        \begin{cases}
        \dfrac{45}{\pi h^6}(h - r), & r \leq h \\
        0, & r > h
        \end{cases}
        \]
- \(\mathbf{F}_i^{\text{gravity}} = \rho_i \mathbf{g}\)
    - \(g\): gravitational acceleration vector
    - \(\rho\): density


### Time Integration (Semi-implicit Euler)
- Acceleration \(a_i = \dfrac{F_i}{\rho_i}\)
- Velocity Update: \(\mathbf{v}^{new}_i = \mathbf{v}^{old}_i + a_i \Delta t\)
    - \(\Delta t\) is time step; 0.005 in my simulation
- Position Update: \(\mathbf{x}^{new}_i = \mathbf{x}^{old}_i + \mathbf{v}^{new}_i \Delta t\)

### Collision Damping at Boundary
If a particle hits a boundary
\[\mathbf{v}^{new} = \mathbf{v}^{old} \times d\]
- \(\mathbf{v}\): velocity of a particle
- \(d\): damping factor

### Predefined Parameters for SPH simulation
- \(k\): gas constant
- \(\rho_0\): rest density
- \(m\): mass of particle
- \(\mu\): viscosity coefficient
- \(g\): gravity
- \(\Delta t\): time step
- \(h\): smoothing radius
- \(d\): damping factor at collision